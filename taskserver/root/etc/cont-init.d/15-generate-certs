#!/usr/bin/with-contenv sh
#shellcheck shell=sh

if [ "$LE_DISABLE" = "true" ] && [ ! -s /ssl_certs/domain.key ]; then
  printf "Generating self-signed server certs\n"
  apk --no-cache add curl gnutls-utils
  cd /tmp || exit 1
  curl -sSL https://api.github.com/repos/gothenburgbitfactory/taskserver/tarball/master -o /tmp/taskd.tar.gz
  mkdir /tmp/taskd
  tar xzf taskd.tar.gz -C /tmp/taskd --strip 1
  cd taskd/pki || exit 1
  ./generate
  mv server.key.pem /ssl_certs/domain.key
  mv server.cert.pem /ssl_certs/domain.crt
  printf "Copying server certs for client\n"
  cp ca.cert.pem /server_cert/
  cd /tmp || exit 1
  rm -rf /tmp/taskd /tmp/taskd.tar.gz
  apk --no-cache del curl gnutls-utils
fi
